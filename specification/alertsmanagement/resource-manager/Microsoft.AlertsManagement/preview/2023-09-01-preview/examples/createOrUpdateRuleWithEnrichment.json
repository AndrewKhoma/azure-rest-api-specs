{
  "parameters": {
    "subscriptionId": "ffffffff-ffff-ffff-ffff-ffffffffffff",
    "resourceGroupName": "promResourceGroup",
    "ruleGroupName": "myPrometheusRuleGroup",
    "api-version": "2023-09-01-preview",
    "parameters": {
      "location": "East US",
      "properties": {
        "description": "This is the description of a rule group containing an alerting rule with enrichment",
        "scopes": [
          "/subscriptions/ffffffff-ffff-ffff-ffff-ffffffffffff/resourceGroups/myResourceGroup/providers/microsoft.monitor/accounts/myAzureMonitorWorkspace"
        ],
        "rules": [
          {
            "alert": "Billing_Processing_Very_Slow",
            "expression": "job_type:billing_jobs_duration_seconds:99p5m > 30",
            "for": "PT5M",
            "enrichmentConfigurations": {
              "enrichments": [
                {
                  "title": "Number of OOM killed events by container",
                  "type": "PrometheusInstantQuery",
                  "query": "sum by (cluster,container)(label_replace( kube_pod_container{cluster='$cluster', namespace='namespace1'}'}",
                  "variables": {
                    "cluster": "${data.alertContext.labels.cluster}"
                  }
                },
                {
                  "title": "Number of OOM killed events by container",
                  "type": "PrometheusRangeQuery",
                  "includeResults": true,
                  "datasources": [
                    "/subscriptions/00000000-0000-aaaa-bbbb-000000000000/resourceGroups/MyRg/providers/microsoft.monitor/accounts/monitorAccount1"
                  ],
                  "query": "sum by (cluster,container,replicaset,namespace)(label_replace( kube_pod_container_status_last_terminated_reason{reason='OOMKilled', cluster='cluster1', namespace='namespace1'}'}, 'replicaset', '$1', 'pod', '(.*)(-[a-z0-9]{5})$')) > 0",
                  "variables": {},
                  "lookbackPeriod": "PT15M",
                  "step": "PT15S"
                }
              ]
            }
          }
        ]
      }
    }
  },
  "responses": {
    "200": {
      "headers": {},
      "body": {
        "id": "/subscriptions/ffffffff-ffff-ffff-ffff-ffffffffffff/resourceGroups/promResourceGroup/providers/Microsoft.AlertsManagement/prometheusRuleGroups/myPrometheusRuleGroup",
        "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
        "location": "East US",
        "properties": {
          "description": "This is the description of a rule group containing an alerting rule with enrichment",
          "scopes": [
            "/subscriptions/ffffffff-ffff-ffff-ffff-ffffffffffff/resourceGroups/myResourceGroup/providers/microsoft.monitor/accounts/myAzureMonitorWorkspace"
          ],
          "rules": [
            {
              "alert": "Billing_Processing_Very_Slow",
              "expression": "job_type:billing_jobs_duration_seconds:99p5m > 30",
              "for": "PT5M",
              "enrichmentConfigurations": {
                "enrichments": [
                  {
                    "title": "Number of OOM killed events by container",
                    "type": "PrometheusInstantQuery",
                    "query": "sum by (cluster,container)(label_replace( kube_pod_container{cluster='$cluster', namespace='namespace1'}'}",
                    "variables": {
                      "cluster": "${data.alertContext.labels.cluster}"
                    }
                  },
                  {
                    "title": "Number of OOM killed events by container",
                    "type": "PrometheusRangeQuery",
                    "includeResults": true,
                    "datasources": [
                      "/subscriptions/00000000-0000-aaaa-bbbb-000000000000/resourceGroups/MyRg/providers/microsoft.monitor/accounts/monitorAccount1"
                    ],
                    "query": "sum by (cluster,container,replicaset,namespace)(label_replace( kube_pod_container_status_last_terminated_reason{reason='OOMKilled', cluster='cluster1', namespace='namespace1'}'}, 'replicaset', '$1', 'pod', '(.*)(-[a-z0-9]{5})$')) > 0",
                    "variables": {},
                    "lookbackPeriod": "PT15M",
                    "step": "PT15S"
                  }
                ]
              }
            }
          ]
        }
      }
    },
    "201": {
      "headers": {},
      "body": {
        "id": "/subscriptions/ffffffff-ffff-ffff-ffff-ffffffffffff/resourceGroups/promResourceGroup/providers/Microsoft.AlertsManagement/prometheusRuleGroups/myPrometheusRuleGroup",
        "type": "Microsoft.AlertsManagement/prometheusRuleGroups",
        "location": "East US",
        "properties": {
          "description": "This is the description of a rule group containing an alerting rule with enrichment",
          "scopes": [
            "/subscriptions/ffffffff-ffff-ffff-ffff-ffffffffffff/resourceGroups/myResourceGroup/providers/microsoft.monitor/accounts/myAzureMonitorWorkspace"
          ],
          "rules": [
            {
              "alert": "Billing_Processing_Very_Slow",
              "expression": "job_type:billing_jobs_duration_seconds:99p5m > 30",
              "for": "PT5M",
              "enrichmentConfigurations": {
                "enrichments": [
                  {
                    "title": "Number of OOM killed events by container",
                    "type": "PrometheusInstantQuery",
                    "query": "sum by (cluster,container)(label_replace( kube_pod_container{cluster='$cluster', namespace='namespace1'}'}",
                    "variables": {
                      "cluster": "${data.alertContext.labels.cluster}"
                    }
                  },
                  {
                    "title": "Number of OOM killed events by container",
                    "type": "PrometheusRangeQuery",
                    "includeResults": true,
                    "datasources": [
                      "/subscriptions/00000000-0000-aaaa-bbbb-000000000000/resourceGroups/MyRg/providers/microsoft.monitor/accounts/monitorAccount1"
                    ],
                    "query": "sum by (cluster,container,replicaset,namespace)(label_replace( kube_pod_container_status_last_terminated_reason{reason='OOMKilled', cluster='cluster1', namespace='namespace1'}'}, 'replicaset', '$1', 'pod', '(.*)(-[a-z0-9]{5})$')) > 0",
                    "variables": {},
                    "lookbackPeriod": "PT15M",
                    "step": "PT15S"
                  }
                ]
              }
            }
          ]
        }
      }
    }
  }
}
